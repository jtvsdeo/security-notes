# Stack Based Buffer Overflow 
##  Exploiting Free CD to MP3 Converter v3.1

> Writing an address to EIP so it can lead to an instruction that we want

We can change the EIP address and point it to our supplied instructions so the program executes what we ask it to


### Jumping to stack

There are two ways we can direct the execution flow
1. Write the ESP address to EIP. This way it executes code found at the top of the stack
2. Use a JMP ESP to redirect 


### Using JMP ESP to redirect

To find this instruction, look through
1. Programs .exe file
2. Programs or other .dll libraries used 

Using ERC:
`ERC --ModuleInfo`

After the modules load, skip files with:
* NXCompat since the files has stack exec protection
* Rebase or ASLR since these protection would cause address changes


**Find files that are set FALSE to all protections**

As we can see this file indicates that all memory protection is disabled

![](../../../Assets/Pasted%20image%2020220724204450.png) 

Once we locate a file, we can go to `Symbols>(file chosen)>(double click)`

`CPU Tab> Right click> Search For > All Modules > Command` and then JMP ESP 

![](../../../Assets/Pasted%20image%2020220724205023.png)

If we had a large list of loaded modules, we could search through all of them by right-clicking on the main top right `CPU` pane and selecting `Search For> All Modules> Command`, then entering `jmp esp`.

> We also have to make sure none of these instruction addresses contain bad chars, else: our payload will get truncated



### Alternate Approach

We can look for patterns with similar functions. An example is `PUSH ESP` + `RET`
If we are searching for 2 instructions, the easiest way to do is through machine code.
Using: `msf-nasm-shell` or an online assembler such as `https://defuse.ca/online-x86-assembler.htm#disassembly`, we can get the commands

Command for JMP ESP + RET = `54 C3`

Now we can press `ctrl+b` to search for a HEX pattern of 54 C3 and if we double click on any options we can see there is a `RET` right after

![](../../../Assets/Pasted%20image%2020220724212557.png)

We can use `457418`

### Summary
1. Use ESP address 
2. Load modules with disabled security and look for JMP ESP instruction
3. Pick an address that does not contain any bad characters

